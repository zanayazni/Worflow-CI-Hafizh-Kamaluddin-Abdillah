name: ML Training + Docker (MLflow Project)

on:
  push:
    branches: ["master"]
    paths-ignore:
      - "MLProject/classification_report_rf_ci.txt"
      - "MLProject/confusion_matrix.txt"
      - "MLProject/last_run_id.txt"
  pull_request:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-and-dockerize:
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: false
          activate-environment: mlproject-env
          environment-file: MLProject/conda.yaml

      - name: Run MLflow Project
        shell: bash -l {0}
        working-directory: MLProject
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          set -euo pipefail
          mlflow run . \
            --env-manager=local \
            --experiment-name "CI - Seattle Weather RF"

      - name: Get latest MLflow run_id
        shell: bash -l {0}
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          from pathlib import Path
          from mlflow.tracking import MlflowClient

          tracking_uri = os.environ["MLFLOW_TRACKING_URI"]
          experiment_name = "CI - Seattle Weather RF"
          client = MlflowClient(tracking_uri=tracking_uri)

          exp = client.get_experiment_by_name(experiment_name)
          if exp is None:
              raise SystemExit(f"Experiment not found: {experiment_name}")

          runs = client.search_runs(
              experiment_ids=[exp.experiment_id],
              order_by=["attributes.start_time DESC"],
              max_results=1,
          )
          if not runs:
              raise SystemExit("No runs found in experiment")

          run_id = runs[0].info.run_id
          out_path = Path("MLProject/last_run_id.txt")
          out_path.write_text(run_id, encoding="utf-8")
          print(f"Latest RUN_ID={run_id}")
          PY

      - name: Commit training artifacts
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add \
            MLProject/classification_report_rf_ci.txt \
            MLProject/confusion_matrix.txt \
            MLProject/last_run_id.txt

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore(ci): update ML artifacts [skip ci]"
          git push

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image via MLflow
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          set -euo pipefail
          RUN_ID=$(cat MLProject/last_run_id.txt)
          IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/seattle-weather-mlflow"
          IMAGE_TAG="ci-${{ github.run_number }}"

          mlflow --version

          mlflow models build-docker \
            -m "runs:/${RUN_ID}/model" \
            -n "${IMAGE_BASE}:${IMAGE_TAG}"

          docker tag "${IMAGE_BASE}:${IMAGE_TAG}" "${IMAGE_BASE}:latest"

      - name: Push Docker image
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          set -euo pipefail
          IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/seattle-weather-mlflow"
          IMAGE_TAG="ci-${{ github.run_number }}"
          docker push "${IMAGE_BASE}:${IMAGE_TAG}"
          docker push "${IMAGE_BASE}:latest"
