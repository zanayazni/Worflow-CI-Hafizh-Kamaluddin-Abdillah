name: ML Training + Docker (MLflow)

on:
  push:
    branches: ["master"]
    paths-ignore:
      - "MLProject/classification_report_rf_ci.txt"
      - "MLProject/confusion_matrix.txt"
      - "MLProject/last_run_id.txt"
  pull_request:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  train-and-dockerize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: false
          activate-environment: mlproject-env
          environment-file: MLProject/conda.yaml

      - name: Train model (logs to local MLflow store)
        shell: bash -l {0}
        working-directory: MLProject
        run: |
          set -euo pipefail
          python modelling.py \
            --tracking_uri "file:${GITHUB_WORKSPACE}/mlruns" \
            --experiment_name "CI - Seattle Weather Best RandomForest"

      - name: Debug MLflow + Docker
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        shell: bash -l {0}
        run: |
          set -euo pipefail
          python -V
          mlflow --version
          docker version

      - name: Resolve model path from MLflow run
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        shell: bash -l {0}
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          set -euo pipefail
          python - <<'PY' > mlflow_env.txt
          import os
          from urllib.parse import urlparse, unquote
          from pathlib import Path
          from mlflow.tracking import MlflowClient

          run_id = Path("MLProject/last_run_id.txt").read_text().strip()
          tracking_uri = os.environ["MLFLOW_TRACKING_URI"]
          client = MlflowClient(tracking_uri=tracking_uri)
          run = client.get_run(run_id)

          artifact_uri = run.info.artifact_uri

          print(f"RUN_ID={run_id}")
            print(f"MODEL_URI=runs:/{run_id}/model")
            print(f"ARTIFACT_URI={artifact_uri}")

          if artifact_uri.startswith("file:"):
              parsed = urlparse(artifact_uri)
              # parsed.path is already absolute on Linux runners (e.g. /home/runner/...)
              artifact_path = unquote(parsed.path)
              model_path = str(Path(artifact_path) / "model")
              print(f"MODEL_PATH={model_path}")
          PY

          cat mlflow_env.txt
          cat mlflow_env.txt >> "$GITHUB_ENV"

      - name: Commit training artifacts back to repo
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add \
            MLProject/classification_report_rf_ci.txt \
            MLProject/confusion_matrix.txt \
            MLProject/last_run_id.txt

          if git diff --cached --quiet; then
            echo "No artifact changes to commit."
            exit 0
          fi

          git commit -m "chore(ci): update ML artifacts [skip ci]"
          git push

      - name: Log in to Docker Hub
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image via MLflow
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        shell: bash -l {0}
        env:
          MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns
        run: |
          set -euo pipefail

          # Make Docker build logs verbose in GitHub Actions
          export DOCKER_BUILDKIT=1
          export BUILDKIT_PROGRESS=plain

          RUN_ID="$(cat MLProject/last_run_id.txt)"
          echo "Using RUN_ID=${RUN_ID}"

          echo "MLflow model URI: runs:/${RUN_ID}/model"
          if [[ -n "${MODEL_PATH:-}" ]]; then
            echo "MLflow model path: ${MODEL_PATH}"
            ls -la "${MODEL_PATH}" || true
          fi

          IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/seattle-weather-mlflow"
          IMAGE_TAG="ci-${{ github.run_number }}"

          MODEL_SOURCE="${MODEL_PATH:-runs:/${RUN_ID}/model}"
          mlflow models build-docker \
            -m "${MODEL_SOURCE}" \
            -n "${IMAGE_BASE}:${IMAGE_TAG}"

          docker tag "${IMAGE_BASE}:${IMAGE_TAG}" "${IMAGE_BASE}:latest"


      - name: Push Docker image
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_BASE="${{ secrets.DOCKERHUB_USERNAME }}/seattle-weather-mlflow"
          IMAGE_TAG="ci-${{ github.run_number }}"
          docker push "${IMAGE_BASE}:${IMAGE_TAG}"
          docker push "${IMAGE_BASE}:latest"
